<div class="container">
  <div class="row">
    <div class="col s6 m8 l8">
      <h4 id="message">Begin!</h4>
    </div>
    <div class="col s6 m4 l4">
      <h5>Remaining Time: <span id="timer">180</span></h5>
    </div>
  </div>
  <div class="row">
    <div class="col s6 m5 l5">
      <h5 style="color: #<%= roomOptions.team1Color %>;"><%= roomOptions.team1 %> Score</h5>
      <h4 id="team1Score" style="color: #<%= roomOptions.team1Color %>;">0</h4>
    </div>
    <div class="col s6 m2 l2">
      <button id="end" class="btn red">STOP!</button>
    </div>
    <div class="col s6 m5 l5 right-align">
      <h5 style="color: #<%= roomOptions.team2Color %>;"><%= roomOptions.team2 %> Score</h5>
      <h4 id="team2Score" style="color: #<%= roomOptions.team2Color %>;">0</h4>
    </div>
  </div>
  <div class="row">
    <div class="col s12 m12 l12">
      <hr>
    </div>
  </div>
  <div class="row">
    <div class="col s12 m6 l6">
      <img id="deck" class="card-back" src="/images/card_back.png">
    </div>
    <div class="col s12 m6 l6">
      <div id="flip">
        <h3>Draw Now!</h3>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col s12 m6 l6 center">
      <button id="skip" class="btn orange">SKIP!</button>
      <button id="start" class="btn">START!</button>
    </div>
  </div>
</div>

<script>
$(document).ready(function(){
  var DEFAULT_START = 10;
  var startTime = DEFAULT_START;
  var interval = null;
  var first = true;
  var score1 = 0;
  var score2 = 0;
  var team1Turn = true;
  startTurn();

  function tick(){
    startTime -= 1;
    $('#timer').html(startTime);

    if(startTime === 59){
      $('#timer').css('color', 'orange');
    }
    if(startTime === 29){
      $('#timer').css('color', '#f00');
    }
    if(startTime === 10){
      $('#timer').css('font-size', '32px');
    }
    if(startTime === 0){
      clearInterval(interval);
      finishedTurn();
    }
  }

  function startTurn(){
    console.log('starting turn');
    $('#start').css('display', 'none');
    $('#skip').css('display', 'block');
    $('#message').html('Begin!');
    startTime = DEFAULT_START;
    $('#deck').bind('click', next);
    interval = setInterval(tick, 1000);
  }

  function finishedTurn(){
    console.log('finishing turn');
    //switch to other team
    team1Turn = !team1Turn;
    //disable deck click
    $('#deck').unbind('click');
    //display message
    $('#message').html('Turn done! ' + (team1Turn ? '<%=roomOptions.team1%>' : '<%=roomOptions.team2%>') + ', press start when ready!');
    //show start button
    $('#start').css('display', 'block');
    $('#skip').css('display', 'none');
  }

  function flipCard(){
    console.log('card flip');
    //AJAX to select a card
    $.ajax({
      method: 'GET',
      url: '/game/card',
      success: function(data){
        console.log('success', data.card);
        //Display the card
        var title = $('<h3>').append(data.card.word);
        var description = $('<h6>').append(data.card.description);
        var image = $('<img>').attr('class', 'responsive-img');
        var newDiv = $('<div>').append(title).append(description);

        if(data.card.image != ''){
          image.attr('src', data.card.image);
        }
        else{
          image.attr('src', '/images/default_card.png');
          image.css('opacity', '0.1');
        }

        $('#flip').empty().append(newDiv).append($('<div>').append(image));

        //Don't allow another click right away
        $('#deck').unbind('click');
        setTimeout(function(){
          if(startTime > 1){
            $('#deck').bind('click', next);
          }
        }, 1000);
      },
      error: function(err){
        console.log('err', err);
      }
    });
  }

  function next(){
    if(startTime > 1){
      console.log('next');
      if(first){
        first = false;
      }
      else{
        awardPoint();
      }
      flipCard();
    }
  }

  function awardPoint(){
    if(team1Turn){
      score1 += 1;
      $('#team1Score').html(score1);
    }
    else{
      score2 += 1;
      $('#team2Score').html(score2);
    }
  }

  $('#skip').click(function(){
    if(startTime > 1){
      console.log('skip');
      flipCard();
    }
  });

  $('#start').click(function(){
    startTime = DEFAULT_START;
    console.log('starting again');
    startTurn();
  });

  $('#end').click(function(){
    console.log('End the game');
    //Redirect to summary page
  })
});
</script>
